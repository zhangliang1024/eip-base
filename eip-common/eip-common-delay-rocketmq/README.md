# RocketMQ 实现有自动延时队列
> 目前`RocketMQ`支持固定的18个等级的延时消息策略，故需要实现自定义时长的延时消息

## 一、思路
> 使用`多段延时`，进行接力的方式来实现无限时间延时
> - 如：2小时35分钟，可以先延迟2小时，在延时30分钟，在延时5分钟
> - 通过逻辑拆分法，用默认的MQ去实现，可支持任意时间的延迟
> - 1分钟内需要发送的采用时间轮方法
> - 延时走默认的延时主题：guava-topic，不走业务topic。当真正需要发送的时候才会走业务topic
> - 存在1分钟内(强制重启带来)的数据丢失问题

![](https://ae04.alicdn.com/kf/H8e24f83232b64c2998a77fbc862d7b60O.png)




## 三、实现优缺点
### 优点
- 只依赖于RocketMQ，可算是0侵入
- 支持任意时间维度的延时

### 缺点
- 极端情况下会有一分钟的数据丢失(服务器重启且满足刚好进入时间轮)
- 增大了MQ自带的延时压力

## 五、参考文档
* [RocketMQ支持任意时间的延时消息，零侵入](https://www.jianshu.com/p/4f968cd96b87)
* [rocketmq自定义延时消息实现](https://blog.csdn.net/sly1311220942/article/details/109448717)
* []()